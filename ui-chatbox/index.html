<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autopilot Nav</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

<style>
    body {
        font-family: Arial;
        background: #f2f2f2;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 30px;
		background-color: #ededed;
    }
    #tabs {
        display: flex;
        margin-bottom: 10px;
    } 
	
	#nav-logo {
	  margin-bottom: 20px;
	  border-radius: 10px;
	  background: linear-gradient(
		to right,
		rgb(31 41 55),
		rgb(31 41 55),
		#35078f,	
		rgb(31 41 55),
		rgb(31 41 55)
	  );
	  background-size: 200% 100%;
	  animation: wave-scroll 4s linear infinite;
        font-family: Lucida Console;
	}

	@keyframes wave-scroll {
	  from { background-position: 0 0; }
	  to   { background-position: 200% 0; }
	}


    .tab {
        padding: 10px 20px;
        border-radius: 6px 6px 0 0;
        cursor: pointer;
        background: #ccc;
        margin-right: 2px;
    }
    .tab.active {
        background: #0078ff;
        color: white;
    }
    #chatbot-block {
    width: 90vw;

    margin:"30px";
    position: relative;
    padding: 3px; /* épaisseur de la bordure */
    border-radius: 10px;
    background: linear-gradient(
        90deg,
        rgb(31 41 55),
        #00BFFF,
        #8A2BE2
    );
    background-size: 200% 200%;
    animation: gradient-move 3s linear infinite;
    margin-bottom: 20px;
    }

    #chatbox {
        width: auto;
        height: 450px;
        overflow-y: auto;
        border-radius: 10px;
        background: #fff;
        padding: 15px;
    }
    @keyframes gradient-move { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .msg {
        padding: 8px 12px;
        border-radius: 6px;
        margin: 6px 0;
        max-width: 80%;
        line-height: 1.4;
    }
    .user {
        background: #0078ff;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    .ai {
        background: #eaeaea;
        color: #333;
        margin-right: auto;
    }
    #inputArea,#searchFilter{
        display: flex;
        width: 90vw;
        max-width:800px;
        margin:auto;
        margin-top: 10px;
    }
    textarea {
        flex: 1;
        padding: 10px;
        border-radius: 6px;
        border: 2px solid transparent;
        font-family: sans-serif;
        font-size: 14px;
        margin-right: 10px !important;
        border: 2px solid  rgba(0,0,0,0.2);
    }
	textarea:focus {
	  outline: none;
	  border: 2px solid rgba(31,41,55,0.6);
	}
    #sendBtn {
        margin-left: 10px;
        padding: 10px 15px;
        border: none;
        background:  rgb(31 41 55);
        color: white;
        border-radius: 6px;
        cursor: pointer;
    }
    .loader {
        font-style: italic;
        opacity: 0.7;
        animation: blink 1s infinite;
    }
    @keyframes blink {
        0% { opacity: 0.7; }
        50% { opacity: 0.3; }
        100% { opacity: 0.7; }
    }
	

    /* */
 .upload-btn {
  position: relative;
  display: inline-flex;
  align-items: center;
  padding: 8px 14px;
  background-color: rgb(31 41 55);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  overflow: hidden;
}

.upload-btn, #sendBtn {
  transition: background 0.5s, transform 0.2s;
}
.upload-btn:hover , #sendBtn:hover {
  background-color: #0078ff;
  transform: translateY(-2px);
}

.upload-btn .icon {
  margin-right: 6px;
  font-size: 16px;
}

/* Cacher le vrai input */
.upload-btn .file-input {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}


</style>
</head>
<body>

<nav id="nav-logo" class="bg-gray-800 text-white px-4 py-3 flex items-center justify-between shadow-md rounded-lg" >
  <!-- Logo + Nom -->
  <div class="flex items-center space-x-3" style="margin:auto;">
    <!-- Logo (SVG simple) -->
	<img src="./image/logo2.png" style=" width:auto; height: 60px; ">
    <span class="text-xl font-bold tracking-wide"> AUTO Pilote</span>
  </div>

  <!-- Menu ou boutons à droite -->
  <div class="flex items-center space-x-4">
  </div>
</nav>

<div class="promptArea">
    <div id="chatbot-block">
        <div id="chatbox"></div>
    </div>
	<div id="inputArea">
		<textarea id="message" placeholder="Rechercher prompt..." rows="3" ></textarea>
        <button class="upload-btn">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828L18 8.828a4 4 0 10-5.656-5.656L5 11.172a6 6 0 008.485 8.485L19 15.172" />
            </svg>
            <input type="file" class="file-input" id="fileInput" />
        </button>
 
        <button id="sendBtn" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
        <!-- Icône trombone -->
            <span>Envoyer</span>
        </button>
	</div>
    <div id="searchFilter" style=" margin-top:10px; ">
        <label>
            <input type="checkbox" id="sqlSwitch">
                SQL Request
        </label>
    </div>
</div>

<script>
// Gestion des onglets
const chatTab = document.getElementById("chatTab");
const instrTab = document.getElementById("instrTab");
const chatbox = document.getElementById("chatbox");
const inputArea = document.getElementById("inputArea");
const host ="192.168.1.24" // localhost . ipconfig ipv4 
const sqlSwitch = document.getElementById("sqlSwitch");


// Ajouter message
function addMessage(text, sender, box) {
    const chat = box;
    const div = document.createElement("div");
    div.className = "msg " + sender;
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function addScriptMessageOld(text, sender, box) {
    const chat = box;

    const div = document.createElement("div");
    div.className = "msg " + sender;

    // Parser le HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = text;

    // Copier le HTML sans les scripts
    const scripts = tempDiv.querySelectorAll("script");
    scripts.forEach(s => s.remove());

    div.innerHTML = tempDiv.innerHTML;
    chat.appendChild(div);

    // Exécuter les scripts trouvés
    scripts.forEach(oldScript => {
        const newScript = document.createElement("script");

        if (oldScript.src) {
            // Script externe
            newScript.src = oldScript.src;
        } else {
            // Script inline
            newScript.textContent = oldScript.textContent;
        }

        document.body.appendChild(newScript);
        document.body.removeChild(newScript);
    });
}

function addSQLMessage(data, sender, box) {
    const chat = box;
    const div = document.createElement("div");
    div.className = "msg " + sender;
    console.log("SQL Data:", data);

    // Vérifie si data contient header et content
    if (data && data.header && data.content) {
        // Crée un tableau HTML
        const table = document.createElement("table");
        table.style.borderCollapse = "collapse";
        table.style.width = "100%";
        table.style.marginTop = "5px";

        // Header
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        data.header.forEach(col => {
            const th = document.createElement("th");
            th.textContent = col;
            th.style.border = "1px solid #ccc";
            th.style.padding = "4px";
            th.style.backgroundColor = "#f0f0f0";
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Content
        const tbody = document.createElement("tbody");
        data.content.forEach(row => {
            const tr = document.createElement("tr");
            data.header.forEach(col => {
                const td = document.createElement("td");
                td.textContent = row[col] !== undefined ? row[col] : "";
                td.style.border = "1px solid #ccc";
                td.style.padding = "4px";
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        div.appendChild(table);
    } else {
        // Sinon affiche simplement le texte
        div.textContent = data;
    }

    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

// Ajouter image
function addImage(content, sender, box) {
    const chat = box;
    const div = document.createElement("div");
    div.className = "msg " + sender;
	const img = document.createElement("img");
    img.src = content;
    img.style = "object-fit: contain; width:150px; height:auto; ";
	div.appendChild(img);
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

// Loader
function addLoader(box) {
    const chat = box;
    const div = document.createElement("div");
    div.className = "msg ai loader";
    div.textContent = "⏳ L'IA réfléchit...";
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
}

// Envoi message Chat
function sendMessage() {
    const input = document.getElementById("message");
    const userText = input.value.trim();
    if (!userText) return;

    addMessage(userText, "user", chatbox);
    input.value = "";

    const loader = addLoader(chatbox);

    fetch("http://"+host+":11434/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: userText })
    })
    .then(res => res.json())
    .then(data => {
        chatbox.removeChild(loader);
        const botReply = data.reply;
        const content = botReply.split("ASSISTANT:")[1]?.trim() || botReply;
        addMessage(content, "ai", chatbox);
    })
    .catch(err => {
        chatbox.removeChild(loader);
        addMessage("Erreur : " + err, "ai", chatbox);
    });
}

function sendSqlMessage() {
    const input = document.getElementById("message");
    const userText = input.value.trim();
    if (!userText) return;

    addMessage(userText, "user", chatbox);
    input.value = "";

    const loader = addLoader(chatbox);

    fetch("http://"+host+":11434/api/sql", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: userText })
    })
    .then(res => res.json())   
    .then(data => {
        chatbox.removeChild(loader);
        addSQLMessage(data, "ai", chatbox);
    })
    .catch(err => {
        addMessage("Erreur : " + err, "ai", chatbox);
        chatbox.removeChild(loader);
    });
}


// Listeners
document.getElementById("sendBtn").addEventListener("click", e => {  
       console.log("SQL Switch is ", sqlSwitch.checked);
       if (sqlSwitch.checked) {
            sendSqlMessage(); 
    }
    else {
        sendMessage();
    }
});

document.getElementById("message").addEventListener("keypress", e => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        console.log("SQL Switch is ", sqlSwitch.checked);
        if (sqlSwitch.checked) {
             sendSqlMessage(); 
        }
        else {
           sendMessage();
        }
    }
});


// Upload image
function fileLoader() {
    const input = document.getElementById("fileInput");

    input.addEventListener("change", () => {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();

            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    // ⚡ Création d’un canvas pour réduire la taille
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    // Dimensions cibles (exemple : largeur max 300px)
                    const maxWidth = 300;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;

                    // Dessiner l'image réduite
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Récupérer la version réduite en Base64 (JPEG qualité 80%)
                    const img64 = canvas.toDataURL("image/jpeg", 0.8);

                    // Afficher l’image réduite dans le chat
                    addImage(img64, "user", chatbox);

                    // Loader IA
                    const loader = addLoader(chatbox);

                    // Envoi au backend
                    fetch("http://"+host+":11434/api/prompt/image", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ prompt: img64 })
                    })
                    .then(res => res.json())
                    .then(data => {
                        chatbox.removeChild(loader);
                        const botReply = data.reply;
                         const assistantText = botReply.trim() || botReply;
                        addMessage(assistantText, "ai", chatbox);
                    })
                    .catch(err => {
                         chatbox.removeChild(loader);
                        addMessage("Erreur : " + err, "ai", chatbox);
                    });
                };
                img.src = e.target.result;
            };

            reader.readAsDataURL(file);
        }
    });
}

fileLoader();
</script>

</body>
</html>